<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wedding Photo Upload</title>
    <link rel="stylesheet" href="/public/styles.css" />
  </head>
  <body class="guest-page">
    <main class="container">
      <section class="card hero">
        <p class="wedding-title">Dan and Abi&apos;s Wedding</p>
        <p class="wedding-subtitle">Share your favourite moments with us</p>
        <h1>Share Your Wedding Photos and Videos</h1>
        <p>Photo gallery: <strong><%= totalPhotoCount %> / <%= maxTotalPhotos %></strong></p>
        <p>Video gallery: <strong><%= totalVideoCount %> / <%= maxTotalVideos %></strong></p>
      </section>

      <section class="card upload-section" data-active-tab="<%= activeTab %>">
        <h2>Upload</h2>

        <% if (message) { %>
          <p class="alert success"><%= message %></p>
        <% } %>

        <% if (error) { %>
          <p class="alert error"><%= error %></p>
        <% } %>

        <div class="upload-tabs" role="tablist" aria-label="Upload type">
          <button type="button" class="upload-tab-btn" data-tab-btn="photos" role="tab">Photos</button>
          <button type="button" class="upload-tab-btn" data-tab-btn="videos" role="tab">Videos</button>
        </div>

        <section class="upload-panel" data-upload-panel="photos" role="tabpanel">
          <form action="/upload" method="POST" enctype="multipart/form-data" class="upload-form">
            <label for="name-photos">Your name</label>
            <input id="name-photos" name="name" type="text" maxlength="120" required />

            <label for="photos">Your photos (up to <%= maxPhotoPerPerson %>)</label>
            <input
              id="photos"
              name="photos"
              type="file"
              accept="image/*"
              multiple
              required
              class="file-input-hidden"
            />
            <button type="button" id="choose-photos-btn" class="secondary">Choose Photos</button>
            <p id="photo-selection-status" class="small-note">No photos selected yet.</p>

            <button type="submit" id="upload-photos-submit-btn" disabled>Upload Photos</button>
          </form>

          <p class="small-note">Only image files are accepted (max 20MB each).</p>
        </section>

        <section class="upload-panel" data-upload-panel="videos" role="tabpanel">
          <form action="/upload/videos" method="POST" enctype="multipart/form-data" class="upload-form" id="video-upload-form">
            <label for="name-videos">Your name</label>
            <input id="name-videos" name="name" type="text" maxlength="120" required />

            <label for="videos">Your videos (up to <%= maxVideoPerPerson %>)</label>
            <input
              id="videos"
              name="videos"
              type="file"
              accept="video/*"
              multiple
              required
              class="file-input-hidden"
            />
            <button type="button" id="choose-videos-btn" class="secondary">Choose Videos</button>
            <p class="small-note">On iPhone/Android, the device&apos;s tick/done button is controlled by your phone and may pause while videos prepare.</p>
            <p id="video-selection-status" class="small-note">No videos selected yet.</p>
            <p id="video-size-warning" class="alert error" hidden></p>

            <button type="submit" id="upload-videos-submit-btn" disabled>Upload Videos</button>
            <button type="button" id="cancel-video-upload-btn" class="secondary" hidden>Cancel Upload</button>
          </form>

          <div id="video-upload-progress" class="upload-progress" hidden>
            <div id="video-upload-progress-bar" class="upload-progress-bar"></div>
          </div>
          <p id="video-upload-status" class="small-note" hidden>Preparing upload...</p>

          <p class="small-note">
            Video uploads are accepted up to <%= maxVideoSizeMb %>MB per file for better quality clips.
          </p>
        </section>
      </section>

      <section class="card qr-section">
        <h2>Guest QR Code</h2>
        <p>Print or share this QR code so guests can open this upload page quickly.</p>
        <img src="<%= qrCodeDataUrl %>" alt="QR code for wedding photo upload page" class="qr-image" />
        <p class="url"><%= baseUrl %></p>
      </section>

      <section class="card admin-link">
        <a href="/admin/login">Admin Login</a>
      </section>
    </main>
    <script>
      (function () {
        const uploadSection = document.querySelector('.upload-section');
        if (!uploadSection) {
          return;
        }

        const buttons = Array.from(document.querySelectorAll('[data-tab-btn]'));
        const panels = Array.from(document.querySelectorAll('[data-upload-panel]'));
        const initialTab = uploadSection.getAttribute('data-active-tab') === 'videos' ? 'videos' : 'photos';

        function setActiveTab(tabName) {
          buttons.forEach((button) => {
            const isActive = button.getAttribute('data-tab-btn') === tabName;
            button.classList.toggle('active', isActive);
            button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          });

          panels.forEach((panel) => {
            const isActive = panel.getAttribute('data-upload-panel') === tabName;
            panel.classList.toggle('active', isActive);
            panel.hidden = !isActive;
          });
        }

        buttons.forEach((button) => {
          button.addEventListener('click', function () {
            setActiveTab(button.getAttribute('data-tab-btn'));
          });
        });

        function bindFilePicker(config) {
          const fileInput = document.getElementById(config.inputId);
          const chooseButton = document.getElementById(config.chooseButtonId);
          const submitButton = document.getElementById(config.submitButtonId);
          const status = document.getElementById(config.statusId);

          if (!fileInput || !chooseButton || !submitButton || !status) {
            return;
          }

          let waitingForPicker = false;
          function updateSelectionState() {
            const count = fileInput.files ? fileInput.files.length : 0;
            if (count === 0) {
              status.textContent = waitingForPicker && config.preparingLabel ? config.preparingLabel : config.emptyLabel;
              submitButton.disabled = true;
              return;
            }

            waitingForPicker = false;
            status.textContent = `${count} ${config.itemLabel}${count === 1 ? '' : 's'} selected.`;
            submitButton.disabled = false;
          }

          let pendingPickerCheck = false;
          function scheduleFallbackCheck() {
            if (!pendingPickerCheck) {
              pendingPickerCheck = true;
              setTimeout(function () {
                pendingPickerCheck = false;
                updateSelectionState();
              }, 180);
            }
          }

          chooseButton.addEventListener('click', function () {
            waitingForPicker = true;
            if (config.preparingLabel) {
              status.textContent = config.preparingLabel;
            }
            try {
              if (typeof fileInput.showPicker === 'function') {
                fileInput.showPicker();
              } else {
                fileInput.click();
              }
            } catch (_e) {
              fileInput.click();
            }
            scheduleFallbackCheck();
          });

          fileInput.addEventListener('input', updateSelectionState);
          fileInput.addEventListener('change', updateSelectionState);
          window.addEventListener('focus', scheduleFallbackCheck);
          document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
              scheduleFallbackCheck();
            }
          });
          updateSelectionState();
        }

        bindFilePicker({
          inputId: 'photos',
          chooseButtonId: 'choose-photos-btn',
          submitButtonId: 'upload-photos-submit-btn',
          statusId: 'photo-selection-status',
          emptyLabel: 'No photos selected yet.',
          itemLabel: 'photo'
        });

        bindFilePicker({
          inputId: 'videos',
          chooseButtonId: 'choose-videos-btn',
          submitButtonId: 'upload-videos-submit-btn',
          statusId: 'video-selection-status',
          emptyLabel: 'No videos selected yet.',
          preparingLabel: 'Preparing selected videos... this can take a moment on iPhone/Android.',
          itemLabel: 'video'
        });

        const videoForm = document.getElementById('video-upload-form');
        const videoInput = document.getElementById('videos');
        const videoChooseBtn = document.getElementById('choose-videos-btn');
        const videoSubmitBtn = document.getElementById('upload-videos-submit-btn');
        const videoNameInput = document.getElementById('name-videos');
        const videoProgress = document.getElementById('video-upload-progress');
        const videoProgressBar = document.getElementById('video-upload-progress-bar');
        const videoStatus = document.getElementById('video-upload-status');
        const cancelVideoUploadBtn = document.getElementById('cancel-video-upload-btn');
        const videoSizeWarning = document.getElementById('video-size-warning');

        if (
          videoForm &&
          videoInput &&
          videoChooseBtn &&
          videoSubmitBtn &&
          videoNameInput &&
          videoProgress &&
          videoProgressBar &&
          videoStatus &&
          cancelVideoUploadBtn &&
          videoSizeWarning
        ) {
          let activeVideoUploadXhr = null;

          function formatBytes(bytes) {
            const gb = 1024 * 1024 * 1024;
            const mb = 1024 * 1024;
            if (bytes >= gb) {
              return `${(bytes / gb).toFixed(2)} GB`;
            }
            return `${(bytes / mb).toFixed(1)} MB`;
          }

          function updateVideoSizeWarning() {
            const files = Array.from(videoInput.files || []);
            if (files.length === 0) {
              videoSizeWarning.hidden = true;
              videoSizeWarning.textContent = '';
              return;
            }

            const totalBytes = files.reduce(function (sum, file) {
              return sum + (file.size || 0);
            }, 0);

            const totalMb = totalBytes / (1024 * 1024);
            if (totalMb >= 350) {
              videoSizeWarning.hidden = false;
              videoSizeWarning.textContent = `You selected ${formatBytes(totalBytes)} of videos. Upload may take several minutes, especially on mobile data.`;
              return;
            }

            videoSizeWarning.hidden = true;
            videoSizeWarning.textContent = '';
          }

          function setUploadingUiState(isUploading, statusText) {
            if (statusText) {
              videoStatus.hidden = false;
              videoStatus.textContent = statusText;
            } else if (!isUploading) {
              videoStatus.hidden = true;
            }

            videoSubmitBtn.disabled = isUploading || !videoInput.files || videoInput.files.length === 0;
            videoChooseBtn.disabled = isUploading;
            videoNameInput.readOnly = isUploading;
            cancelVideoUploadBtn.hidden = !isUploading;

            if (!isUploading) {
              activeVideoUploadXhr = null;
              if (!videoInput.files || videoInput.files.length === 0) {
                videoProgress.hidden = true;
              }
              updateVideoSizeWarning();
            }
          }

          cancelVideoUploadBtn.addEventListener('click', function () {
            if (activeVideoUploadXhr) {
              activeVideoUploadXhr.abort();
            } else {
              setUploadingUiState(false, 'Upload cancelled.');
            }
          });

          videoForm.addEventListener('submit', function (event) {
            event.preventDefault();

            if (!videoInput.files || videoInput.files.length === 0) {
              setUploadingUiState(false, 'Choose at least one video first.');
              return;
            }

            const formData = new FormData(videoForm);
            videoProgress.hidden = false;
            videoProgressBar.style.width = '0%';
            videoSizeWarning.hidden = true;
            setUploadingUiState(true, 'Uploading videos...');

            const xhr = new XMLHttpRequest();
            activeVideoUploadXhr = xhr;
            xhr.open('POST', '/upload/videos?ajax=1');
            xhr.timeout = 1000 * 60 * 20;

            xhr.upload.onprogress = function (e) {
              if (!e.lengthComputable) {
                return;
              }
              const pct = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
              videoProgressBar.style.width = `${pct}%`;
              videoStatus.textContent = `Uploading videos... ${pct}%`;
            };

            xhr.onload = function () {
              let payload = null;
              try {
                payload = JSON.parse(xhr.responseText || '{}');
              } catch (_e) {
                payload = null;
              }

              if (payload && payload.redirectUrl) {
                window.location.href = payload.redirectUrl;
                return;
              }

              setUploadingUiState(false, 'Upload finished. Refreshing...');
              window.location.reload();
            };

            xhr.onerror = function () {
              setUploadingUiState(false, 'Upload failed. Please try again.');
            };

            xhr.onabort = function () {
              setUploadingUiState(false, 'Upload cancelled.');
            };

            xhr.ontimeout = function () {
              setUploadingUiState(false, 'Upload timed out. Please try fewer or smaller videos.');
            };

            xhr.send(formData);
          });

          videoInput.addEventListener('change', updateVideoSizeWarning);
          updateVideoSizeWarning();
        }

        setActiveTab(initialTab);
      })();
    </script>
  </body>
</html>
