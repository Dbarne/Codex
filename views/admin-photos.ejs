<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wedding Photos Admin</title>
    <link rel="stylesheet" href="/public/styles.css" />
  </head>
  <body class="admin-page">
    <main class="container wide">
      <section class="card header-row">
        <div>
          <p class="eyebrow">Control Centre</p>
          <p class="wedding-title">Dan and Abi&apos;s Wedding</p>
          <p class="wedding-subtitle">Media collection admin</p>
          <h1><a href="/" class="title-link">Wedding Media Admin</a></h1>
          <div class="admin-tabs">
            <a href="/admin/photos" class="admin-tab-link <%= activeTab === 'photos' ? 'active' : '' %>">Photos</a>
            <a href="/admin/videos" class="admin-tab-link <%= activeTab === 'videos' ? 'active' : '' %>">Videos</a>
          </div>
          <p><strong><%= photoCount %></strong> / <strong><%= maxTotalPhotos %></strong> total photos</p>
          <p><strong><%= videoCount %></strong> / <strong><%= maxTotalVideos %></strong> total videos</p>
          <p>
            Active tab: <strong><%= totalCount %></strong> / <strong><%= maxTotal %></strong>
            (<%= activeTab === 'videos' ? 'videos' : 'photos' %>)
          </p>
          <p>
            Per uploader cap: <strong><%= maxPerPerson %></strong>
            <%= activeTab === 'videos' ? 'videos' : 'photos' %>
          </p>
          <% if (activeTab === 'videos') { %>
            <p>Video size limit: <strong><%= maxVideoSizeMb %>MB</strong> per file</p>
          <% } %>
        </div>
        <div class="admin-actions">
          <form action="<%= activeTab === 'videos' ? '/admin/videos/download' : '/admin/photos/download' %>" method="GET">
            <button type="submit">Download All <%= activeTab === 'videos' ? 'Videos' : 'Photos' %></button>
          </form>
          <form
            action="<%= activeTab === 'videos' ? '/admin/videos/delete-all' : '/admin/photos/delete-all' %>"
            method="POST"
            onsubmit="return confirm('Delete ALL <%= activeTab === 'videos' ? 'videos' : 'photos' %> permanently?');"
          >
            <button type="submit" class="danger">Delete All <%= activeTab === 'videos' ? 'Videos' : 'Photos' %></button>
          </form>
          <form action="/admin/logout" method="POST">
            <button type="submit" class="secondary">Logout</button>
          </form>
        </div>
      </section>

      <% if (message) { %>
        <p class="alert success"><%= message %></p>
      <% } %>

      <% if (error) { %>
        <p class="alert error"><%= error %></p>
      <% } %>

      <section class="admin-insights-grid">
        <article class="card">
          <h2>Export Health</h2>
          <p><strong>ZIP support:</strong> <%= exportHealth.zipAvailable ? 'Available' : 'Unavailable' %></p>
          <p><strong>Missing photos on disk:</strong> <%= exportHealth.missingPhotos %></p>
          <p><strong>Missing videos on disk:</strong> <%= exportHealth.missingVideos %></p>
          <p>
            <strong>Free disk space:</strong>
            <%= exportHealth.freeDiskMb === null ? 'Unknown' : (exportHealth.freeDiskMb + ' MB') %>
          </p>
          <% if (exportHealth.warnings.length > 0) { %>
            <% exportHealth.warnings.forEach((warning) => { %>
              <p class="small-note"><strong>Warning:</strong> <%= warning %></p>
            <% }) %>
          <% } else { %>
            <p class="small-note">No export health warnings.</p>
          <% } %>
          <p class="small-note">
            JSON endpoint:
            <a href="/admin/export-health" target="_blank" rel="noreferrer">/admin/export-health</a>
          </p>
        </article>

        <article class="card">
          <h2>Upload Analytics</h2>
          <% if (!analytics.topUploaders.length) { %>
            <p class="small-note">No upload activity yet.</p>
          <% } else { %>
            <ul class="insight-list">
              <% analytics.topUploaders.forEach((uploader) => { %>
                <li>
                  <strong><%= uploader.name %></strong>:
                  <%= uploader.photo_count %> photos,
                  <%= uploader.video_count %> videos,
                  <%= (uploader.total_bytes / (1024 * 1024)).toFixed(1) %> MB total
                </li>
              <% }) %>
            </ul>
          <% } %>
          <h3 class="small-heading">Last 7 days</h3>
          <% if (!analytics.uploadVolume.length) { %>
            <p class="small-note">No uploads recorded.</p>
          <% } else { %>
            <ul class="insight-list">
              <% analytics.uploadVolume.forEach((day) => { %>
                <li><strong><%= day.day %></strong>: <%= day.photo_count %> photos, <%= day.video_count %> videos</li>
              <% }) %>
            </ul>
          <% } %>
        </article>
      </section>

      <section class="photo-grid">
        <% if (mediaItems.length === 0) { %>
          <section class="card">
            <p>No <%= activeTab === 'videos' ? 'video' : 'photo' %> uploads yet.</p>
          </section>
        <% } %>

        <% mediaItems.forEach((item) => { %>
          <article class="card photo-card media-card">
            <% if (activeTab === 'videos') { %>
              <video controls preload="metadata" class="video-preview">
                <source src="/admin/video/<%= item.id %>" type="<%= item.mime_type %>" />
                Your browser does not support video playback.
              </video>
            <% } else { %>
              <a href="/admin/photo/<%= item.id %>" target="_blank" rel="noreferrer">
                <img src="/admin/photo/<%= item.id %>" alt="<%= item.original_name %>" loading="lazy" />
              </a>
            <% } %>
            <div class="photo-meta">
              <p><strong>Uploader:</strong> <%= item.uploader_name %></p>
              <p><strong>File:</strong> <%= item.original_name %></p>
              <p><strong>Uploaded:</strong> <%= item.uploaded_at %></p>
              <p><strong>Size:</strong> <%= (item.size / (1024 * 1024)).toFixed(2) %> MB</p>
              <form
                action="<%= activeTab === 'videos' ? ('/admin/video/' + item.id + '/delete') : ('/admin/photo/' + item.id + '/delete') %>"
                method="POST"
                onsubmit="return confirm('Delete this <%= activeTab === 'videos' ? 'video' : 'photo' %> permanently?');"
              >
                <button type="submit" class="danger">Delete <%= activeTab === 'videos' ? 'Video' : 'Photo' %></button>
              </form>
            </div>
          </article>
        <% }) %>
      </section>

      <% const currentPage = typeof page === 'number' ? page : 1; %>
      <% const totalPageCount = typeof totalPages === 'number' ? totalPages : 1; %>

      <% if (totalPageCount > 1) { %>
        <section class="card pagination-row">
          <% if (currentPage > 1) { %>
            <a class="page-link" href="<%= activeTab === 'videos' ? '/admin/videos' : '/admin/photos' %>?page=<%= currentPage - 1 %>">Previous</a>
          <% } else { %>
            <span class="page-link disabled">Previous</span>
          <% } %>

          <p class="small-note page-label">Page <strong><%= currentPage %></strong> of <strong><%= totalPageCount %></strong></p>

          <% if (currentPage < totalPageCount) { %>
            <a class="page-link" href="<%= activeTab === 'videos' ? '/admin/videos' : '/admin/photos' %>?page=<%= currentPage + 1 %>">Next</a>
          <% } else { %>
            <span class="page-link disabled">Next</span>
          <% } %>
        </section>
      <% } %>
    </main>
  </body>
</html>
